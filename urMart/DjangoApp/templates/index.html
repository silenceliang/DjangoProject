{% load static %}
<!doctype html>
<html lang='en'>
<html>
    <link rel="stylesheet" type="text/css" href="{% static 'css/btn_style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">  
    <head>
        <title>Urmart</title>
    </head>
    <body>
        {% csrf_token %} 
        <select id='product_select'> 
          <option selected disabled hidden>Select Product</option>
          {% for p in allCategory %}
          <option>{{p.p_id}}</option>
          {% endfor %}
        </select>
        <input id='number' onkeypress="return isNumberKey(event)" type='text' Placeholder="Number"></input>
        <button type="button" id="add_order">
          <svg class="svg-icon" viewBox="0 0 20 20">
            <path d="M14.613,10c0,0.23-0.188,0.419-0.419,0.419H10.42v3.774c0,0.23-0.189,0.42-0.42,0.42s-0.419-0.189-0.419-0.42v-3.774H5.806c-0.23,0-0.419-0.189-0.419-0.419s0.189-0.419,0.419-0.419h3.775V5.806c0-0.23,0.189-0.419,0.419-0.419s0.42,0.189,0.42,0.419v3.775h3.774C14.425,9.581,14.613,9.77,14.613,10 M17.969,10c0,4.401-3.567,7.969-7.969,7.969c-4.402,0-7.969-3.567-7.969-7.969c0-4.402,3.567-7.969,7.969-7.969C14.401,2.031,17.969,5.598,17.969,10 M17.13,10c0-3.932-3.198-7.13-7.13-7.13S2.87,6.068,2.87,10c0,3.933,3.198,7.13,7.13,7.13S17.13,13.933,17.13,10"></path>   
          </svg>
        </button>
        <input id='customer_id' onkeypress="return isNumberKey(event)" type='text' Placeholder="Customer ID"></input>
        <input id='vip_or_not' type='checkbox' checked>whether vip or not</input>

    {% block Table %}
    <div class="container">
    <h4 class="mt-4 border-bottom">Product List</h4>
    <table id='prod_tab' class="table">
            <thead class="thead-dark">
              <tr>
                <th scope="col">ProductID</th>
                <th scope="col">stock_pcs</th>
                <th scope="col">price</th>
                <th scope="col">shop_id</th>
                <th scope="col">vip</th>
              </tr>
            </thead>
      <tbody>
        {% csrf_token %}
        {% for p in allCategory %}
        <tr>
          <th scope="row">{{ p.p_id }}</th>
          <td>{{ p.s_pcs }}</td>
          <td>{{ p.price }}</td>
          <td>{{ p.s_id }}</td>
          <td>
            <input class='product-vip' type='checkbox' onclick="selectOnlyThis(this)" {% if p.vip %} checked {% endif %}></input>
          </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
</div>

    <div class="container">
    <h4 class="mt-4 border-bottom">Order Record</h4>
    <table id='ord_tab' class="table">
      <thead class="thead-dark">
        <tr>
          <th scope="col">OrderID</th>
          <th scope="col">product_id</th>
          <th scope="col">qty</th>
          <th scope="col">price</th>
          <th scope="col">shop_id</th>
          <th scope="col">CustomerID</th>
        </tr>
      </thead>

      <tbody>
      {% csrf_token %}
      {% if allOrder %}
      {% for o in allOrder %}
      <tr>
          <td>{{ o.o_id }}</td>
          <td>{{ o.p_id }}</td>
          <td>{{ o.qty }}</td>
          <td>{{ o.price }}</td>
          <td>{{ o.s_id }}</td>
          <td>{{ o.c_id }}</td>
          <td>
              <button type="button" class="del-ord">
                <svg class="svg-icon" viewBox="0 0 20 20">
                  <path d="M14.776,10c0,0.239-0.195,0.434-0.435,0.434H5.658c-0.239,0-0.434-0.195-0.434-0.434s0.195-0.434,0.434-0.434h8.684C14.581,9.566,14.776,9.762,14.776,10 M18.25,10c0,4.558-3.693,8.25-8.25,8.25c-4.557,0-8.25-3.691-8.25-8.25c0-4.557,3.693-8.25,8.25-8.25C14.557,1.75,18.25,5.443,18.25,10 M17.382,10c0-4.071-3.312-7.381-7.382-7.381C5.929,2.619,2.619,5.93,2.619,10c0,4.07,3.311,7.382,7.381,7.382C14.07,17.383,17.382,14.07,17.382,10"></path>
                </svg>
              </button>
          </td>
      </tr>
      {% endfor %}
      {% endif %}
      </tbody>
    </table>
    <div class="row">
    <button id="find_top3" class="btn btn-outline-dark">Top3</button>
    <div id="top3_res"></div>
    </div>

  </div>
  {% endblock Table %}
  {% block javasript %}
  <script>

    function selectOnlyThis(id){
      var myCheckbox = document.getElementsByClassName("myCheckbox");
      Array.prototype.forEach.call(myCheckbox,function(el){
        el.checked = false;
      });
      id.checked = true;
    };
    /** Only input numerous number. **/
    function isNumberKey(text){
      let charCode = (text.which) ? text.which : text.keyCode;
      return !(charCode > 31 && (charCode < 48 || charCode > 57))
    }
    /* Reading CSRF token from cookies. */
    function getCookie(c_name){
        if (document.cookie.length > 0){
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1){
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) c_end = document.cookie.length;
                // unescape (deprecated) ---> decodeURIComponent
                // reference: MDN 
                return decodeURIComponent(document.cookie.substring(c_start,c_end));
            }
        }
        return "";
    }
    /* Delete the selected item in the order list. */
    function AppendDeleteBtnListener(e){
      e.addEventListener("click", function(){
      let row = this.closest('tr');
      let order_content = {
        'o_id': row.cells[0].innerHTML,
        'product_id':row.cells[1].innerHTML,
        'qty':row.cells[2].innerHTML,
        'action':'del'
      };
      fetch('delFromOrder', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              "X-CSRFToken": getCookie("csrftoken"),
              "Accept": "application/json",
            },
            body: JSON.stringify(order_content),
            credentials: 'include'
          })
          .then((response) => response.json())
          .then((data) => {
            this.closest('tr').remove();
            if(data['notice']){
              alert('Enter the goods ' + data['p_id'] +' from zero to n.');
            }

            let ProductTable = document.getElementById('prod_tab');
            let pt_nums = ProductTable.rows.length;
            for(let i=1;i<pt_nums;i++){
              let target_prod = ProductTable.rows[i].cells[0].innerHTML;
              if(target_prod == data['p_id']){
                let ord_num = data['qty'];
                let cur_num = ProductTable.rows[i].cells[1].innerHTML;
                ProductTable.rows[i].cells[1].innerHTML = parseInt(cur_num) + parseInt(ord_num);
                break
              }
            }

          })
          .catch((error) => {
            console.error('Error:', error);
          });

      });
    }
    /* Add the product to the oder list. */
    function addProductToOrderList(data){
      let field = ['o_id','p_id','qty','price','s_id','c_id'];
      
      let OrderTable = document.getElementById('ord_tab');
      let ProductTable = document.getElementById('prod_tab');
      
      let header_counts = OrderTable.rows[0].cells.length;
      let pt_nums = ProductTable.rows.length;
      
      for(let i=1;i<pt_nums;i++){
        let target_prod = ProductTable.rows[i].cells[0].innerHTML;
        
        if(target_prod == data[field[1]]){
          let ord_num = data[field[2]];
          let cur_num = ProductTable.rows[i].cells[1].innerHTML;
          ProductTable.rows[i].cells[1].innerHTML = cur_num - ord_num;
          break
        }
      }

      let OrderTableTbody = OrderTable.getElementsByTagName('tbody')[0];
      let newRow = OrderTableTbody.insertRow(0);
      for(let i=0;i<header_counts;i++){
        let newCell = newRow.insertCell(i);
        let textNode = document.createTextNode(data[field[i]]);
        newCell.appendChild(textNode);
      };
      /* New a button be able to delete this row. */
      let newCell = newRow.insertCell(header_counts);
      let createBtn = document.createElement('button');
      createBtn.className = 'del-ord';
      let htms = "<svg class='svg-icon' viewBox='0 0 20 20'> \
            <path d='M14.776,10c0,0.239-0.195,0.434-0.435,0.434H5.658c-0.239,0-0.434-0.195-0.434-0.434s0.195-0.434,0.434-0.434h8.684C14.581,9.566,14.776,9.762,14.776,10 M18.25,10c0,4.558-3.693,8.25-8.25,8.25c-4.557,0-8.25-3.691-8.25-8.25c0-4.557,3.693-8.25,8.25-8.25C14.557,1.75,18.25,5.443,18.25,10 M17.382,10c0-4.071-3.312-7.381-7.382-7.381C5.929,2.619,2.619,5.93,2.619,10c0,4.07,3.311,7.382,7.381,7.382C14.07,17.383,17.382,14.07,17.382,10'></path> \
            </svg>";
      createBtn.innerHTML = htms;
      AppendDeleteBtnListener(createBtn);
      let textNode = document.createTextNode(createBtn);
      newCell.appendChild(createBtn);
    }

    /* initialize all buttons. */
    document.getElementById('add_order').addEventListener("click", function(){
      let selector = document.getElementById('product_select');
      let product_num = document.getElementById('number').value;
      let customer_id = document.getElementById('customer_id').value;
      let vip_or_not = document.getElementById('vip_or_not').checked;
      /* fill the form properly */
      if(selector.selectedIndex==0 || product_num=="" || customer_id==""){
        alert('Please fill the actual number or select properly.');
        return;
      }
      /* Guanrantee quantity bigger than zero.*/
      if(parseInt(product_num)<=0){
        alert('Do not input quantity number less than zero.');
        return;
      }

      let product_vip_or_not = document.getElementsByClassName('product-vip')[selector.selectedIndex-1].checked;
      let data = {
        'product_id': selector.options[selector.selectedIndex].text,
        'qty': product_num,
        'customer_id': customer_id,
        'vip': vip_or_not,
        'prod_vip': product_vip_or_not,
        'action': 'add'
      };

        /* To Send a request to add items to order list. */
      fetch('add2order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
            'Accept': 'application/json',
          },
          body: JSON.stringify(data),
          credentials: 'include'
        })
        .then((response) => response.json())
        .then((data) => {
          console.log('Success:', data);
          if(data['status'])
            addProductToOrderList(data);
          else{
            alert(data['message']);
            console.error(data['message']);
          }
        })
        .catch((error) => {
          console.error('Error: ', error);
        });
    });
    
    document.getElementById('find_top3').addEventListener("click",function(){
        
          /* To Send a request to add items to order list. */
        fetch('findTop3', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken'),
              'Accept': 'application/json',
            },
            credentials: 'include'
          })
          .then((response) => response.json())
          .then((response) => response['results'])
          .then((data) => {
            let res = "";
            console.log('Success:', data);
            for(let i=0;i<data.length;i++){
              res += "the top." + i + " product : "  + data[i]['p_id'] + "; total sell volume : " + data[i]['total_sell'] + "<br>";
            }
            document.getElementById('top3_res').innerHTML = res;
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      });

    let tr_btn = document.getElementsByClassName('del-ord');
    for (let i=0;i<tr_btn.length; i++) {
      AppendDeleteBtnListener(tr_btn[i]);
    };

  
  </script>
  {% endblock %}
  <script src="{% static 'js/bootstrap.bundle.min.js'  %}"></script>
  </body>
</html>
